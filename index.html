<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Privacy Policies</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .policy-card {
        cursor: pointer;
        transition: box-shadow 0.2s;
      }
      .policy-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      }
      #policy-content img {
        max-width: 100%;
      }
      #policy-content h1,
      #policy-content h2,
      #policy-content h3 {
        margin-top: 1.5rem;
      }
      /* Fallback in case Bootstrap CSS fails to load */
      .d-none {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="#" id="nav-home">
          üîí Privacy Policies
        </a>
      </div>
    </nav>

    <div class="container py-4">
      <!-- Policy list view -->
      <div id="list-view">
        <h2 class="mb-1">Available Policies</h2>
        <p class="text-muted mb-4">
          Select a policy below to read its full content.
        </p>
        <div id="policy-list" class="row g-3">
          <div class="col-12 text-center text-muted py-5">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading policies‚Ä¶
          </div>
        </div>
      </div>

      <!-- Policy detail view -->
      <div id="detail-view" class="d-none">
        <button
          class="btn btn-outline-primary btn-sm mb-4"
          id="back-btn"
        >
          ‚Üê Back to policies
        </button>
        <div class="card shadow-sm">
          <div class="card-body px-4 py-4" id="policy-content"></div>
        </div>
      </div>

      <div id="error-view" class="d-none alert alert-danger mt-4" role="alert">
        Failed to load the policy. Please try again later.
      </div>
    </div>

    <script src="marked.min.js"></script>
    <script>
      const listView = document.getElementById("list-view");
      const detailView = document.getElementById("detail-view");
      const errorView = document.getElementById("error-view");
      const policyList = document.getElementById("policy-list");
      const policyContent = document.getElementById("policy-content");
      const backBtn = document.getElementById("back-btn");
      const navHome = document.getElementById("nav-home");

      function showList() {
        listView.classList.remove("d-none");
        detailView.classList.add("d-none");
        errorView.classList.add("d-none");
        window.location.hash = "";
      }

      function showError() {
        listView.classList.add("d-none");
        detailView.classList.add("d-none");
        errorView.classList.remove("d-none");
      }

      async function showPolicy(file, name) {
        try {
          const res = await fetch(file);
          if (!res.ok) throw new Error("Network response was not ok");
          const markdown = await res.text();
          policyContent.innerHTML = marked.parse(markdown);
          listView.classList.add("d-none");
          detailView.classList.remove("d-none");
          errorView.classList.add("d-none");
          document.title = name + " ‚Äì Privacy Policies";
          window.scrollTo(0, 0);
        } catch (e) {
          showError();
        }
      }

      async function loadPolicies() {
        try {
          const res = await fetch("policies.json");
          if (!res.ok) throw new Error("Could not load policies.json");
          const policies = await res.json();

          if (policies.length === 0) {
            policyList.innerHTML =
              '<div class="col-12 text-muted">No policies available yet.</div>';
            return;
          }

          policyList.innerHTML = policies
            .map(
              (p, i) => `
            <div class="col-12 col-md-6 col-lg-4">
              <div class="card policy-card h-100 shadow-sm" data-index="${i}">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">${escapeHtml(p.name)}</h5>
                  ${p.description ? `<p class="card-text text-muted flex-grow-1">${escapeHtml(p.description)}</p>` : ""}
                  <button class="btn btn-primary btn-sm mt-3 align-self-start view-btn" data-index="${i}">
                    View Policy
                  </button>
                </div>
              </div>
            </div>`
            )
            .join("");

          document.querySelectorAll(".view-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const idx = parseInt(btn.dataset.index, 10);
              const policy = policies[idx];
              window.location.hash = encodeURIComponent(policy.file);
              showPolicy(policy.file, policy.name);
            });
          });

          // Handle direct link via hash
          if (window.location.hash) {
            const file = decodeURIComponent(window.location.hash.slice(1));
            const policy = policies.find((p) => p.file === file);
            if (policy) showPolicy(policy.file, policy.name);
          }
        } catch (e) {
          policyList.innerHTML =
            '<div class="col-12"><div class="alert alert-danger">Failed to load policy list.</div></div>';
        }
      }

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      backBtn.addEventListener("click", showList);
      navHome.addEventListener("click", (e) => {
        e.preventDefault();
        document.title = "Privacy Policies";
        showList();
      });

      loadPolicies();
    </script>
  </body>
</html>
